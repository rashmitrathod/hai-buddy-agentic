<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>HAI Buddy â€” Realtime Chat</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px auto;
      max-width: 700px;
    }
    #messages {
      border: 1px solid #ddd;
      padding: 10px;
      width: 100%;
      height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
      border-radius: 6px;
      background: #fafafa;
    }
    .msg { margin: 8px 0; }
    .assistant {
      background: #e8f0fe;
      padding: 8px;
      border-radius: 6px;
      color: #003366;
    }
    .user {
      text-align: right;
      background: #d1ffd1;
      padding: 8px;
      border-radius: 6px;
    }
    #input-area {
      display: flex;
      gap: 8px;
    }
    #textInput {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    #sendBtn { background: #4CAF50; color: white; }
    #voiceBtn { background: #2196F3; color: white; }
  </style>
</head>
<body>

<h2>HAI Buddy â€” Realtime Chat</h2>

<div id="messages"></div>

<div id="input-area">
  <input id="textInput" type="text" placeholder="Type your message..." />
  <button id="sendBtn">Send</button>
  <button id="voiceBtn">ðŸŽ¤ Voice</button>
</div>

<audio id="replyAudio" controls style="display:none"></audio>

<script>
  // --- Generate a stable session ID for memory binding ---
  const sessionId = crypto.randomUUID();

  // --- Utility: append message ---
  function appendMessage(text, cls) {
    const m = document.createElement("div");
    m.className = "msg";
    const inner = document.createElement("div");
    inner.className = cls;
    inner.textContent = text;
    m.appendChild(inner);
    document.getElementById("messages").appendChild(m);

    const div = document.getElementById("messages");
    div.scrollTop = div.scrollHeight;
  }

  appendMessage("Connected to HAI Buddy", "assistant");

  // --- Set up SSE for streaming responses ---
  let currentEventSource = null;

  function startSSE(question) {
    if (currentEventSource) currentEventSource.close();

    const url = `${location.origin}/stream/chat/${sessionId}?question=` + encodeURIComponent(question);
    currentEventSource = new EventSource(url);

    currentEventSource.onmessage = (evt) => {
      try {
        const obj = JSON.parse(evt.data);

        if (obj.type === "assistant_typing") {
          appendMessage("Thinking...", "assistant");
        } else if (obj.type === "assistant_message") {
          appendMessage(obj.text, "assistant");

          if (obj.audio_url) {
            const audio = document.getElementById("replyAudio");
            audio.src = obj.audio_url;
            audio.style.display = "block";
            audio.play().catch(() => {});
          }
        } else if (obj.type === "connection") {
          // ignore
        }
      } catch(e) {
        console.error("Bad SSE message:", evt.data, e);
      }
    };

    currentEventSource.onerror = (err) => {
      console.error("SSE error", err);
      currentEventSource.close();
    };
  }

  // --- Text Send button ---
  document.getElementById("sendBtn").onclick = () => {
    const text = document.getElementById("textInput").value.trim();
    if (!text) return;

    appendMessage(text, "user");
    startSSE(text);
    document.getElementById("textInput").value = "";
  };

  // --- Voice button logic (record â†’ stt â†’ auto-send) ---
  const voiceBtn = document.getElementById("voiceBtn");

  voiceBtn.onclick = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      // const recorder = new MediaRecorder(stream);
      const recorder = new MediaRecorder(stream, { mimeType: "audio/webm;codecs=opus" });


      const chunks = [];

      recorder.ondataavailable = e => chunks.push(e.data);

      recorder.onstop = async () => {
        const blob = new Blob(chunks, { type: "audio/webm" });
        const form = new FormData();
        form.append("file", blob, "audio.webm");

        // speech â†’ text
        const stt = await fetch(`${location.origin}/stt`, {
          method: "POST",
          body: form
        });
        const sttJson = await stt.json();
        const transcript = sttJson.transcript || "";

        document.getElementById("textInput").value = transcript;
        document.getElementById("sendBtn").click();

        stream.getTracks().forEach(t => t.stop());
      };

      recorder.start();
      voiceBtn.textContent = "ðŸŽ™ Recordingâ€¦";

      setTimeout(() => {
        recorder.stop();
        voiceBtn.textContent = "ðŸŽ¤ Voice";
      }, 4000); // 4 seconds recording

    } catch (err) {
      console.error("Mic error:", err);
      alert("Microphone not accessible. Browser blocked it or HTTPS required.");
    }
  };
</script>

</body>
</html>